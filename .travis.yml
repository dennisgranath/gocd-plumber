language: go
branches:
  only:
  - master
go:
- '1.6'
env:
  global:
  - GH_REF=github.com/dennisgranath/gocd-plumber.git
  - secure: AonExW7WtEpkXSRBR14dmQMj7letJwU61WPz15l4YWyMOW4CCLpj8MDp5W1MhwoS+Om4lN9iPQK02Y7vVTrb1vqJcA5AS3ZfhcEpSPm0Kq93f4d7YZ5qauKy3/mh4FSWFCwijz1bh/sIKb1syP3gHy+XJYb4ybxVeGV8J43zXzQCY8Lfh9dALOR1eve5FqHQD7WHEJYKx6/WEnlWJHcIOIbGJgc6QtX8SGODDZDy88dzFoRYUJLOyJTGvT+u3viCcP6abBktLs2QotbJqxHMQunHxAZj2hOZWYpupUrEvRjGcg1+jdfY1X3LGwCU4OSIwljA7KWACQRr29sW9i986ffBZc5GPWRAby5TfKGFH/4b0h8/Ax+Jp51VvSELBAVUB7A0zfxG1ULUupwMAQKgLcZ4005op7OD+vG5jqRjghsZCALuUKni+Ejjco9c+PIN0tIhXAnyOKZ8J/Hz0yIOV9hP+aDuba0YUkmQW6OP94KnU2+1NqvlVuLEHEcMFo8XZAkJN3gl7Zhnz0hTW9ZpBNfbDke2XrBRo8G7Poo7PixXfpeyvHcLFXvT3KdxFibUbMTkfPozPgFEy46ihftVvmv5nfiWT8pOVHgNboZnU8A7xK54OuQKmzNxJludTkgIVUU2LZGdiZpYtkLh5entHk5d3FsAlTmRM7ZlZbkQa8A=
before_script: |
  # Get semver version for HEAD if exists
  VERSION=$(git tag --contains HEAD | grep "v[0-9]*\.[0-9]*\.[0-9]*")
  if [ -z "$VERSION" ]; then
    # Increment minor and set patch to 0
    VERSION=$(git describe --tags --match 'v[0-9]*\.[0-9]*\.[0-9]*' | \
      awk -F. '{printf("%s.%s.0", $1, $2+1)}')

    # Set git user config for tag
    git config user.name "CI Bot"
    git config user.email "bot@gmail.com"

    # Create new version tag
    git tag -a "$VERSION" -m "Version $VERSION"
    echo "New version $VERSION"
  else
    echo "HEAD already tagged $VERSION"
  fi
script:
- make
before_deploy: |
  # Get semver version for HEAD
  VERSION=$(git tag --contains HEAD | grep "v[0-9]*\.[0-9]*\.[0-9]*")

  # Push tag if not present on origin
  git ls-remote --exit-code origin refs/tags/$VERSION || {
    # Send stdout to dev/null to protect GH_TOKEN
    git push --quiet "https://${GH_TOKEN}@${GH_REF}" --tags > /dev/null 2>&1
  }

deploy:
- provider: releases
  api_key:
    secure: GLJTWI8owdc20KJid5XpGfQbaobY1cggfPWzedktjk39XEl1Qzq2WW5TGGE91xjCXzqKGmnmQOznoLcIeVauEm67YxTD0nFU2wD6bl1o/RoFTtJ6QijEtDvCwIX4awUzWoyxNTJBr3Xw4CtvR5zEa9BEC/4ujT+1QiiYVGIAmLCFYhey6kucqfBCFqRxRpiR2QkfyvEYpR82TNovQ/Aq7ket/gkfVexoV5kXmvUB0sAlyr3Impl65qucp+XJEGUyNWOvQye1UBfJ2zB2M5qSu/0dTrhex0uN7r39BIM824SEt3z0ytISGFi7W25AfnNbbuzfR7l5il+Ut5i4gBe4gMNUNDyYidejARqCEp7CPN+NoD8H0Non5ZPGcXtTemT+q6L9/sMMvm2caTwtvZTHflREIAoqpetXPA6893WkkOf5TtBtEfHetOnHkWMhBduUNeII8Nzt3QAMae6KAOTxIrlIwJEPSTwxA2QKVolB/IXDAIl6N+wYnddz5JHW4xUEX16CZdSaeSmTo/FTZkFbhRP5m0TQ9C2rQGD9OgAVqP+e1tGMbqjY6ZeQ/2lSh60aA+WxQ0C7TiZQafHn7mw8i2fy2J6OGcGg4iv+21IOnuu77dsYylG0VUWYI6u3F9wDk484/jl+dO/JKL+IGBmvJuLRLheLeVtdsIKBA35MWBg=
  file: ARTIFACTS/*
  file_glob: true
  skip_cleanup: true
  on:
    repo: dennisgranath/gocd-plumber
